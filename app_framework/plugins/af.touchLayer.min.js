(function(c){c.touchLayer=function(a){c.touchLayer=new e(a);return c.touchLayer};var k=["input","select","textarea"],p=["button","radio","checkbox","range","date"],q=c.os.ios,l=c.os.blackberry,r=c.os.blackberry||c.os.android&&!c.os.chrome,m=c.os.ios,n=!1,f=!1,e=function(a){this.clearTouchVars();a.addEventListener("touchstart",this,!1);a.addEventListener("touchmove",this,!1);a.addEventListener("touchend",this,!1);a.addEventListener("click",this,!1);a.addEventListener("focusin",this,!1);document.addEventListener("scroll",
this,!1);window.addEventListener("resize",this,!1);window.addEventListener("orientationchange",this,!1);this.layer=a;this.scrollEndedProxy_=c.proxy(this.scrollEnded,this);this.exitEditProxy_=c.proxy(this.exitExit,this,[]);this.launchFixUIProxy_=c.proxy(this.launchFixUI,this);var b=this;this.scrollTimeoutExpireProxy_=function(){b.scrollTimeout_=null;b.scrollTimeoutEl_.addEventListener("scroll",b.scrollEndedProxy_,!1)};this.retestAndFixUIProxy_=function(){af.os.android&&(b.layer.style.height="100%");
c.asap(b.testAndFixUI,b,arguments)};document.addEventListener("click",function(a){if(f)return a.preventDefault(),a.stopPropagation(),!1;void 0!==a.clientX&&null!=b.lastTouchStartX&&(2>Math.abs(b.lastTouchStartX-a.clientX)&&2>Math.abs(b.lastTouchStartY-a.clientY))&&(a.preventDefault(),a.stopPropagation())},!0);c.bind(this,"scrollstart",function(a){b.isScrolling=!0;b.scrollingEl_=a;c.feat.nativeTouchScroll||(b.scrollerIsScrolling=!0);b.fireEvent("UIEvents","scrollstart",a,!1,!1)});c.bind(this,"scrollend",
function(a){b.isScrolling=!1;c.feat.nativeTouchScroll||(b.scrollerIsScrolling=!1);b.fireEvent("UIEvents","scrollend",a,!1,!1)});this.launchFixUI(5)};e.prototype={dX:0,dY:0,cX:0,cY:0,touchStartX:null,touchStartY:null,layer:null,scrollingEl_:null,scrollTimeoutEl_:null,scrollTimeout_:null,reshapeTimeout_:null,scrollEndedProxy_:null,exitEditProxy_:null,launchFixUIProxy_:null,reHideAddressBarTimeout_:null,retestAndFixUIProxy_:null,panElementId:"header",blockClicks:!1,allowDocumentScroll_:!1,ignoreNextResize_:!1,
blockPossibleClick_:!1,isScrolling:!1,isScrollingVertical_:!1,wasPanning_:!1,isPanning_:!1,isFocused_:!1,justBlurred_:!1,requiresNativeTap:!1,holdingReshapeType_:null,trackingClick:!1,scrollerIsScrolling:!1,handleEvent:function(a){switch(a.type){case "touchstart":this.onTouchStart(a);break;case "touchmove":this.onTouchMove(a);break;case "touchend":this.onTouchEnd(a);break;case "click":this.onClick(a);break;case "blur":this.onBlur(a);break;case "scroll":this.onScroll(a);break;case "orientationchange":this.onOrientationChange(a);
break;case "resize":this.onResize(a);break;case "focusin":this.onFocusIn(a)}},launchFixUI:function(a){a||(a=2);if(null===this.reHideAddressBarTimeout_)return this.testAndFixUI(0,a)},resetFixUI:function(){this.reHideAddressBarTimeout_&&clearTimeout(this.reHideAddressBarTimeout_);this.reHideAddressBarTimeout_=null},testAndFixUI:function(a,b){var c=this.getReferenceHeight(),g=this.getCurrentHeight();if(c!=g&&!(0.97*g<c&&0.97*c<g))return this.hideAddressBar(a,b),!0;af.os.android&&this.resetFixUI();return!1},
hideAddressBar:function(a,b){if(a>=b)this.resetFixUI();else if(af.os.desktop||af.os.chrome)this.layer.style.height="100%";else if(af.os.android){window.scrollTo(1,1);this.layer.style.height=this.isFocused_||window.innerHeight>window.outerHeight?window.innerHeight+"px":window.outerHeight/window.devicePixelRatio+"px";that=this;var c=a+1;this.reHideAddressBarTimeout_=setTimeout(this.retestAndFixUIProxy_,250*c,[c,b])}else this.isFocused_||(document.documentElement.style.height="5000px",window.scrollTo(0,
0),document.documentElement.style.height=window.innerHeight+"px",this.layer.style.height=window.innerHeight+"px")},getReferenceHeight:function(){return af.os.android?Math.ceil(window.outerHeight/window.devicePixelRatio):window.innerHeight},getCurrentHeight:function(){return af.os.android?window.innerHeight:numOnly(document.documentElement.style.height)},onOrientationChange:function(a){!this.holdingReshapeType_&&this.reshapeTimeout_?this.fireReshapeEvent("orientationchange"):this.previewReshapeEvent("orientationchange")},
onResize:function(a){this.ignoreNextResize_?this.ignoreNextResize_=!1:this.launchFixUI()&&this.reshapeAction()},onClick:function(a){var b=a.target&&void 0!==a.target.tagName?a.target.tagName.toLowerCase():"";if(-1===k.indexOf(b)||this.isFocused_&&a.target===this.focusedElement)c.os.blackberry10&&this.isFocused_&&this.focusedElement.blur();else{b=a.target&&void 0!==a.target.type?a.target.type.toLowerCase():"";if(-1===p.indexOf(b)){this.isFocused_&&this.focusedElement.removeEventListener("blur",this,
!1);this.focusedElement=a.target;this.focusedElement.addEventListener("blur",this,!1);if(!this.isFocused_&&!this.justBlurred_)if(c.trigger(this,"enter-edit",[a.target]),c.os.ios){var d=this;setTimeout(function(){d.fireReshapeEvent("enter-edit")},300)}else this.previewReshapeEvent("enter-edit");this.isFocused_=!0}else this.isFocused_=!1;this.justBlurred_=!1;this.allowDocumentScroll_=!0;q&&a.target.focus()}},previewReshapeEvent:function(a){that=this;this.reshapeTimeout_=setTimeout(function(){that.fireReshapeEvent(a);
that.reshapeTimeout_=null;that.holdingReshapeType_=null},750);this.holdingReshapeType_=a},fireReshapeEvent:function(a){c.trigger(this,"reshape");c.trigger(this,a?a+"-reshape":"unknown-reshape")},reshapeAction:function(){this.reshapeTimeout_?(clearTimeout(this.reshapeTimeout_),this.fireReshapeEvent(this.holdingReshapeType_),this.reshapeTimeout_=this.holdingReshapeType_=null):this.previewReshapeEvent()},onFocusIn:function(a){if(!this.isFocused_)this.onClick(a)},onBlur:function(a){af.os.android&&a.target==
window||(this.isFocused_=!1,this.focusedElement&&this.focusedElement.removeEventListener("blur",this,!1),this.focusedElement=null,this.justBlurred_=!0,c.asap(this.exitEditProxy_,this,[a.target]))},exitExit:function(a){this.justBlurred_=!1;if(!this.isFocused_)if(c.trigger(this,"exit-edit",[a]),this.allowDocumentScroll_=!1,c.os.ios){var b=this;setTimeout(function(){b.fireReshapeEvent("exit-edit")},300)}else this.previewReshapeEvent("exit-edit")},onScroll:function(a){this.allowDocumentScroll_||(this.isPanning_||
a.target!=document)||(this.allowDocumentScroll_=!0,this.wasPanning_?(this.wasPanning_=!1,setTimeout(this.launchFixUIProxy_,2E3,[2])):this.launchFixUI())},onTouchStart:function(a){this.dX=a.touches[0].pageX;this.dY=a.touches[0].pageY;this.lastTimestamp=a.timeStamp;this.lastTouchStartX=this.lastTouchStartY=null;if(c.os.ios){if(n===a.touches[0].identifier)return f=!0,a.preventDefault(),!1;n=a.touches[0].identifier;f=!1}if(this.scrollerIsScrolling)return this.moved=!0,this.scrollerIsScrolling=!1,a.preventDefault(),
!1;this.trackingClick=!0;(m||c.feat.nativeTouchScroll)&&this.checkDOMTree(a.target,this.layer);this.isScrolling&&(null!==this.scrollTimeout_?(clearTimeout(this.scrollTimeout_),this.scrollTimeout_=null,this.scrollTimeoutEl_!=this.scrollingEl_?this.scrollEnded(!1):this.blockPossibleClick_=!0):this.scrollTimeoutEl_&&(this.scrollEnded(!0),this.blockPossibleClick_=!0));if(af.os.android&&a&&a.target&&a.target.getAttribute&&"ignore"==a.target.getAttribute("data-touchlayer")||this.isFocused_&&!c.os.blackberry10)this.allowDocumentScroll_=
this.requiresNativeTap=!0;else if(r&&a.target&&void 0!==a.target.tagName){var b=a.target.tagName.toLowerCase();-1!==k.indexOf(b)&&(this.requiresNativeTap=!0)}else a.target&&(void 0!==a.target.tagName&&"input"==a.target.tagName.toLowerCase()&&"range"==a.target.type)&&(this.requiresNativeTap=!0);this.isPanning_||this.requiresNativeTap?this.isScrollingVertical_&&this.demandVerticalScroll():(this.isScrolling&&!c.feat.nativeTouchScroll||!this.isScrolling)&&a.preventDefault()},demandVerticalScroll:function(){0>=
this.scrollingEl_.scrollTop?this.scrollingEl_.scrollTop=1:this.scrollingEl_.scrollTop+this.scrollingEl_.clientHeight>=this.scrollingEl_.scrollHeight&&(this.scrollingEl_.scrollTop=this.scrollingEl_.scrollHeight-this.scrollingEl_.clientHeight-1)},ignoreScrolling:function(a){return void 0===a.scrollWidth||void 0===a.clientWidth||void 0===a.scrollHeight||void 0===a.clientHeight?!0:!1},allowsVerticalScroll:function(a,b){var c=b.overflowY;return"scroll"==c||"auto"==c&&a.scrollHeight>a.clientHeight?!0:!1},
allowsHorizontalScroll:function(a,b){var c=b.overflowX;return"scroll"==c||"auto"==c&&a.scrollWidth>a.clientWidth?!0:!1},checkDOMTree:function(a,b){if(m&&this.panElementId==a.id)this.isPanning_=!0;else{if(c.feat.nativeTouchScroll){if(this.ignoreScrolling(a))return;var d=window.getComputedStyle(a);if(this.allowsVerticalScroll(a,d)){this.isScrollingVertical_=!0;this.scrollingEl_=a;this.isScrolling=!0;return}this.allowsHorizontalScroll(a,d)&&(this.isScrollingVertical_=!1,this.scrollingEl_=null,this.isScrolling=
!0)}a!=b&&a.parentNode&&this.checkDOMTree(a.parentNode,b)}},scrollEnded:function(a){a&&this.scrollTimeoutEl_.removeEventListener("scroll",this.scrollEndedProxy_,!1);this.fireEvent("UIEvents","scrollend",this.scrollTimeoutEl_,!1,!1);this.scrollTimeoutEl_=null},onTouchMove:function(a){var b=this.moved;this.moved=!0;l&&(this.cY=a.touches[0].pageY-this.dY,this.cX=a.touches[0].pageX-this.dX);this.isPanning_||(this.isScrolling&&(b||this.fireEvent("UIEvents","scrollstart",this.scrollingEl_,!1,!1),this.speedY=
(this.lastY-a.touches[0].pageY)/(a.timeStamp-this.lastTimestamp),this.lastY=a.touches[0].pageY,this.lastX=a.touches[0].pageX,this.lastTimestamp=a.timeStamp),c.os.blackberry10||this.isScrolling&&c.feat.nativeTouchScroll||a.preventDefault())},onTouchEnd:function(a){var b=this.moved;l&&(b=b&&!(10>Math.abs(this.cX)&&10>Math.abs(this.cY)));af.os.ios&&this.requiresNativeTap||(this.allowDocumentScroll_=!1);if(this.isPanning_&&b)this.wasPanning_=!0;else if(b||this.requiresNativeTap)b&&(this.isScrolling&&
(this.scrollTimeoutEl_=this.scrollingEl_,0.01>Math.abs(this.speedY)?this.scrollEnded(!1):this.scrollTimeout_=setTimeout(this.scrollTimeoutExpireProxy_,30)),this.requiresNativeTap&&(this.isFocused_||c.trigger(this,"cancel-enter-edit",[a.target])));else{this.scrollerIsScrolling=!1;if(!this.trackingClick)return;a.preventDefault();this.blockClicks||this.blockPossibleClick_||(b=a.target,3==b.nodeType&&(b=b.parentNode),this.fireEvent("Event","click",b,!0,a.mouseToTouch,a.changedTouches[0]),this.lastTouchStartX=
this.dX,this.lastTouchStartY=this.dY)}this.clearTouchVars()},clearTouchVars:function(){this.speedY=this.lastY=this.cY=this.cX=this.dX=this.dY=0;this.trackingClick=this.blockPossibleClick_=this.requiresNativeTap=this.isScrollingVertical_=this.isScrolling=this.isPanning_=this.moved=!1},fireEvent:function(a,b,d,g,f,e){var h=document.createEvent(a);h.initEvent(b,g,!0);h.target=d;e&&c.each(e,function(a,b){h[a]=b});f&&(h.mouseToTouch=!0);d.dispatchEvent(h)}}})(af);
